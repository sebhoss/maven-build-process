node {

    def repositoryLocation = ".repository"
    def timestamp = new java.text.SimpleDateFormat('yyyy.MM.dd-HHmmss').format(new Date())
    def mavenVersion = "maven-latest"
    def mavenSettings = "repository.metio.wtf"
    def releaseTarget = "metio"
    def skipLocalStaging = "true"

    stage('Cleanup') {
        dir("${repositoryLocation}") {
            deleteDir()
        }
    }

    stage('Checkout') {
        checkout scm
    }

    stage('Versioning') {
        withMaven(
                maven: "${mavenVersion}",
                mavenSettingsConfig: "${mavenSettings}",
                mavenLocalRepo: "${repositoryLocation}") {
            try {
                sh """
                    mvn --batch-mode \
                        --show-version \
                        versions:set \
                        -DgenerateBackupPoms=false \
                        -DnewVersion=${timestamp}
                """
            } catch (exception) {
                currentBuild.result = 'FAILURE'
            }
        }
    }

    stage('Install') {
        withMaven(
                maven: "${mavenVersion}",
                mavenSettingsConfig: "${mavenSettings}",
                mavenLocalRepo: "${repositoryLocation}") {
            try {
                sh """
                    mvn --batch-mode \
                        --show-version \
                        clean install \
                        -Drelease=${releaseTarget}
                """
            } catch (exception) {
                currentBuild.result = 'FAILURE'
            }
        }
    }

    stage('Sign') {
        withCredentials([
                string(credentialsId: 'pgp.secretkey', variable: 'PGP_KEY'),
                string(credentialsId: 'pgp.passphrase', variable: 'PGP_PASSPHRASE')]) {
            withMaven(
                    maven: "${mavenVersion}",
                    mavenSettingsConfig: "${mavenSettings}",
                    mavenLocalRepo: "${repositoryLocation}") {
                try {
                    sh """
                        mvn --batch-mode \
                            --show-version \
                            pgp:sign \
                            -Dpgp.secretKey=keyfile:${PGP_KEY} \
                            -Dpgp.passphrase=literal:'${PGP_PASSPHRASE}'
                    """
                } catch (exception) {
                    currentBuild.result = 'FAILURE'
                }
            }
        }
    }

    stage('Analyze') {
        withSonarQubeEnv('quality.metio.wtf') {
            withMaven(
                    maven: "${mavenVersion}",
                    mavenSettingsConfig: "${mavenSettings}",
                    mavenLocalRepo: "${repositoryLocation}") {
                try {
                    sh """
                        mvn --batch-mode \
                            --show-version \
                            sonar:sonar
                    """
                } catch (exception) {
                    currentBuild.result = 'FAILURE'
                }
            }
        }
    }

    stage('Deploy') {
        configFileProvider([configFile(fileId: "${mavenSettings}", variable: 'MAVEN_SETTINGS')]) {
            withMaven(
                    maven: "${mavenVersion}",
                    mavenLocalRepo: "${repositoryLocation}") {
                try {
                    sh """
                        mvn --batch-mode \
                            --settings $MAVEN_SETTINGS \
                            --show-version \
                            nexus-staging-maven-plugin:deploy \
                            -Drelease=${releaseTarget} \
                            -DskipLocalStaging=${skipLocalStaging}
                    """
                } catch (exception) {
                    currentBuild.result = 'FAILURE'
                }
            }
        }
    }

}
