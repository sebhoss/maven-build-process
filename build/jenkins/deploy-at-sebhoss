node {
    stage "Checkout"
    checkout scm

    stage "Tooling"
    def mvnHome = tool "maven-3.3.9"

    stage "Timestamp"
    sh 'date "+%Y.%m.%d-%H%M%S" > TIMESTAMP'
    def timestamp = readFile("TIMESTAMP")

    try {
        wrap([$class: "ConfigFileBuildWrapper", managedFiles: [[fileId: "5b2469a4-b601-41f5-9ee8-4158696fb575", targetLocation: "settings.xml"]]]) {
            stage "Versioning"
            sh "${mvnHome}/bin/mvn  -s settings.xml versions:set -DgenerateBackupPoms=false -DnewVersion=${timestamp}"

            stage "Build & Deploy"
            sh "${mvnHome}/bin/mvn -s settings.xml clean deploy -DskipLocalStaging=true"
        }
    } finally {
        stage "Cleanup"
        sh "rm -f settings.xml"
        sh "rm -f TIMESTAMP"
    }
}
